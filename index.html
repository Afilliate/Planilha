<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Semanal Otimizado (Novo Hor√°rio)</title>
    <script src="https://cdn.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Define as vari√°veis globais que ser√£o usadas no script principal
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = null;

        // Fun√ß√£o utilit√°ria para obter a data da Segunda-feira da semana atual (para ID do documento)
        window.getWeekStartDate = function() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Domingo, 1 = Segunda, ... 6 = S√°bado
            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Ajusta para a Segunda
            const monday = new Date(now.setDate(diff));
            return monday.toISOString().split('T')[0];
        }

        // Fun√ß√£o obrigat√≥ria para inicializar o Firebase
        async function initializeFirebase() {
            setLogLevel('Debug');
            
            // 1. Configura√ß√£o e Inicializa√ß√£o
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config n√£o encontrado. O rastreamento de progresso n√£o funcionar√°.");
                 document.getElementById('firebase-status').textContent = "ERRO: Configura√ß√£o Firebase ausente.";
                 return;
            }

            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            
            document.getElementById('firebase-status').textContent = "Conectando ao banco de dados...";

            // 2. Autentica√ß√£o
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Erro na autentica√ß√£o:", error);
                document.getElementById('firebase-status').textContent = "ERRO de Autentica√ß√£o.";
                return;
            }

            // 3. Listener de Estado de Autentica√ß√£o (Para garantir que o userId seja definido)
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                    document.getElementById('firebase-status').textContent = `Conectado. Usu√°rio ID: ${window.userId}`;
                    window.checkAndLoadTasks(); // Inicia o carregamento da rotina
                    window.fetchWeeklyHistory(); // Puxa o hist√≥rico salvo
                } else {
                    console.error("Usu√°rio desconectado.");
                    document.getElementById('firebase-status').textContent = "Desconectado.";
                }
            });
        }

        window.saveProgress = async function(taskId, isChecked) {
             if (!window.userId || !window.appId) return;

             const weekStartDate = window.getWeekStartDate();
             const docId = weekStartDate; // ID do documento √© a data da Segunda-feira
             const docRef = doc(window.db, 
                                 'artifacts', window.appId, 
                                 'users', window.userId, 
                                 'weekly_progress', docId);

             // 1. Obt√©m o estado atual para evitar sobrescrever dados de outras tarefas
             let currentData = {};
             try {
                 const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     currentData = docSnap.data();
                 }
             } catch (error) {
                 console.error("Erro ao obter dados atuais:", error);
                 return;
             }

             // 2. Atualiza o detalhe da tarefa
             const detailKey = taskId.startsWith('goal-') ? 'goalsDetail' : 'tasksDetail';
             
             if (!currentData[detailKey]) {
                 currentData[detailKey] = {};
             }
             currentData[detailKey][taskId] = isChecked;

             // 3. Calcula o resumo do progresso
             const allTasks = [...document.querySelectorAll('[data-task]')];
             const totalTasks = allTasks.length;
             const completedTasks = allTasks.filter(item => {
                 const checkbox = item.querySelector('input[type="checkbox"]');
                 return checkbox && checkbox.checked;
             }).length;

             const totalGoals = document.querySelectorAll('[data-task^="goal-"]').length;
             const completedGoals = document.querySelectorAll('[data-task^="goal-"] input:checked').length;
             
             const completionPercentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
             
             currentData.totalTasksCompleted = completedTasks;
             currentData.totalGoalsCompleted = completedGoals;
             currentData.completionPercentage = parseFloat(completionPercentage.toFixed(2));
             currentData.totalTasks = totalTasks;
             currentData.totalGoals = totalGoals;
             currentData.date = weekStartDate; // Garante a data da semana
             currentData.timestamp = new Date().toISOString(); // √öltima atualiza√ß√£o

             // 4. Salva no Firestore
             try {
                 await setDoc(docRef, currentData);
                 console.log("Progresso salvo com sucesso para a semana:", docId);
                 window.fetchWeeklyHistory(); // Atualiza o hist√≥rico imediatamente
             } catch (error) {
                 console.error("Erro ao salvar progresso:", error);
             }
         }

        window.loadProgress = async function() {
            if (!window.userId || !window.appId) return;

            const weekStartDate = window.getWeekStartDate();
            const docId = weekStartDate;
            const docRef = doc(window.db, 
                                'artifacts', window.appId, 
                                'users', window.userId, 
                                'weekly_progress', docId);

            document.getElementById('firebase-status').textContent = "Carregando progresso da semana...";
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Progresso da semana carregado:", data);
                    document.getElementById('firebase-status').textContent = `Progresso de ${data.date} carregado.`;
                    
                    // Aplica as tarefas conclu√≠das
                    const allTasks = document.querySelectorAll('[data-task]');
                    allTasks.forEach(item => {
                        const taskId = item.getAttribute('data-task');
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        
                        if (!checkbox) return;

                        let isCompleted = false;
                        if (taskId.startsWith('goal-') && data.goalsDetail && data.goalsDetail[taskId]) {
                            isCompleted = data.goalsDetail[taskId];
                        } else if (data.tasksDetail && data.tasksDetail[taskId]) {
                            isCompleted = data.tasksDetail[taskId];
                        }

                        if (isCompleted) {
                            checkbox.checked = true;
                            item.classList.add('completed');
                        } else {
                            checkbox.checked = false;
                            item.classList.remove('completed');
                        }
                    });

                } else {
                    document.getElementById('firebase-status').textContent = "Semana nova! Comece a marcar suas tarefas.";
                }
            } catch (error) {
                console.error("Erro ao carregar progresso:", error);
                document.getElementById('firebase-status').textContent = "ERRO ao carregar o progresso.";
            }
        }
        
        // Fun√ß√£o para buscar e exibir todo o hist√≥rico
        window.fetchWeeklyHistory = async function() {
            if (!window.userId || !window.appId) return;
            
            const historyContainer = document.getElementById('history-list');
            historyContainer.innerHTML = `<p class="text-gray-400 text-center">Buscando hist√≥rico...</p>`;

            const progressRef = collection(window.db, 
                                            'artifacts', window.appId, 
                                            'users', window.userId, 
                                            'weekly_progress');
            
            // Query sem orderBy, para obedecer √†s regras do Canvas.
            const q = query(progressRef); 
            
            try {
                const querySnapshot = await getDocs(q);
                let historyData = [];

                querySnapshot.forEach((doc) => {
                    historyData.push(doc.data());
                });
                
                // Ordena os dados no cliente (no JavaScript)
                historyData.sort((a, b) => b.date.localeCompare(a.date));

                if (historyData.length === 0) {
                    historyContainer.innerHTML = `<p class="text-gray-400 text-center p-4">Nenhum hist√≥rico de semana encontrado ainda.</p>`;
                    return;
                }
                
                let historyHTML = '';
                historyData.forEach(data => {
                    const progress = data.completionPercentage || 0;
                    const goalsDone = data.totalGoalsCompleted || 0;
                    const totalGoals = data.totalGoals || 6; 
                    
                    historyHTML += `
                        <div class="bg-gray-700 p-4 rounded-lg shadow-md flex justify-between items-center mb-2">
                            <div>
                                <p class="text-lg font-bold text-cyan-300">Semana In√≠cio: ${data.date}</p>
                                <p class="text-sm text-gray-300">Metas (6 Posts): ${goalsDone} de ${totalGoals} conclu√≠das.</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-extrabold ${progress >= 100 ? 'text-green-400' : progress > 50 ? 'text-yellow-400' : 'text-red-400'}">
                                    ${progress}%
                                </p>
                                <p class="text-xs text-gray-400">Progresso Geral</p>
                            </div>
                        </div>
                    `;
                });

                historyContainer.innerHTML = historyHTML;

            } catch (error) {
                console.error("Erro ao buscar hist√≥rico:", error);
                historyContainer.innerHTML = `<p class="text-red-400 text-center p-4">Erro ao carregar hist√≥rico: ${error.message}</p>`;
            }
        }
        
        initializeFirebase();
    </script>
    <style>
        /* Estilos customizados para a est√©tica */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fundo escuro */
            color: #e5e7eb;
        }
        .task-item {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        .header-bg {
            background-color: #0e7490; /* Azul Ciano Escuro */
            background-image: linear-gradient(135deg, #0e7490 0%, #0891b2 100%);
        }
        /* Corrigindo a cor dos links (labels) quando marcado */
        .completed label {
            color: #9ca3af; /* Cinza mais suave */
        }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 sm:p-8">
        <!-- T√≠tulo Principal -->
        <header class="header-bg p-6 rounded-xl shadow-2xl mb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white text-center">
                ‚úÖ Plano Semanal Otimizado (Novo Hor√°rio de Pico)
            </h1>
            <p class="text-sm sm:text-base text-cyan-100 text-center mt-2">
                Bloco de Foco: **15:00h √†s 18:00h**. Alinhamento total com escola, almo√ßo e academia.
            </p>
        </header>

        <!-- Status do Firebase/Usu√°rio -->
        <div class="text-center mb-6">
            <p id="firebase-status" class="text-sm text-yellow-400 p-2 bg-gray-800 rounded-lg">
                Iniciando conex√£o...
            </p>
        </div>
        
        <!-- Hist√≥rico de Progresso Semanal -->
        <div class="mb-10 p-5 bg-gray-900 rounded-xl shadow-2xl border-l-4 border-yellow-500">
            <h2 class="text-2xl font-bold mb-3 text-yellow-400 border-b border-yellow-700 pb-2">
                üìà Hist√≥rico de Disciplina Semanal
            </h2>
            <div id="history-list" class="space-y-3">
                <!-- O hist√≥rico ser√° carregado aqui -->
                <p class="text-gray-400 text-center p-4">Aguardando conex√£o com o banco de dados...</p>
            </div>
        </div>


        <!-- Objetivos da Semana -->
        <div class="mb-10 p-5 bg-gray-800 rounded-xl shadow-lg border-l-4 border-fuchsia-500">
            <h2 class="text-2xl font-bold mb-3 text-fuchsia-400">
                üéØ Metas de Cria√ß√£o (6 Posts Totais)
            </h2>
            <p class="text-sm text-gray-400 mb-4">Metas de volume: 2 posts por produto (1:1:1).</p>

            <ul class="space-y-2 grid grid-cols-1 sm:grid-cols-3 gap-x-4">
                <li data-task="goal-vpn-1" class="flex items-start">
                    <input type="checkbox" id="goal-vpn-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-vpn-1-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 1: VPN (Gringo)</label>
                </li>
                <li data-task="goal-vpn-2" class="flex items-start">
                    <input type="checkbox" id="goal-vpn-2-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-vpn-2-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 2: VPN (Gringo)</label>
                </li>
                <li data-task="goal-nacional-1" class="flex items-start">
                    <input type="checkbox" id="goal-nacional-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-nacional-1-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 3: Produto Nacional</label>
                </li>
                <li data-task="goal-nacional-2" class="flex items-start">
                    <input type="checkbox" id="goal-nacional-2-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-nacional-2-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 4: Produto Nacional</label>
                </li>
                 <li data-task="goal-milhas-1" class="flex items-start">
                    <input type="checkbox" id="goal-milhas-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-milhas-1-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 5: Seu Produto (Milhas/Afiliados)</label>
                </li>
                 <li data-task="goal-milhas-2" class="flex items-start">
                    <input type="checkbox" id="goal-milhas-2-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-milhas-2-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 6: Seu Produto (Milhas/Afiliados)</label>
                </li>
            </ul>
        </div>
        
        <!-- Bloco de Trabalho - Dias da Semana -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold mb-5 text-cyan-400 border-b border-cyan-700 pb-2">
                Bloco de Trabalho: **15:00h √†s 18:00h** (Seu Pico de Foco)
            </h2>

            <div id="weekly-schedule" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Tasks will be rendered here by JS -->
            </div>
        </div>

        <!-- Fim de Semana e Lazer -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold mb-5 text-green-400 border-b border-green-700 pb-2">
                Fim de Semana e Lazer (Recarregar Energias)
            </h2>
            <div id="weekend-schedule" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- S√ÅBADO -->
                <div class="bg-gray-800 p-5 rounded-xl shadow-lg border-l-4 border-green-500 task-item">
                    <h3 class="text-xl font-bold text-green-400 mb-2">S√ÅBADO</h3>
                    <p class="text-sm text-gray-400 mb-3">10:00 - 12:00 | Foco: Estrat√©gia e Reinvestimento</p>
                    <ul class="space-y-2">
                        <li data-task="saturday-0" class="flex flex-col mb-3 p-2 rounded-md bg-gray-700/50">
                            <div class="flex items-start">
                                <input type="checkbox" id="saturday-0-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-green-600 rounded" onclick="toggleTask(this)">
                                <label for="saturday-0-check" class="text-sm font-medium text-gray-300 flex-1 cursor-pointer">Revis√£o de Metas de 90 Dias: Alinhar o esfor√ßo da semana com o objetivo final (Liberdade Financeira aos 20).</label>
                            </div>
                        </li>
                        <li data-task="saturday-1" class="flex flex-col mb-3 p-2 rounded-md bg-gray-700/50">
                            <div class="flex items-start">
                                <input type="checkbox" id="saturday-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-green-600 rounded" onclick="toggleTask(this)">
                                <label for="saturday-1-check" class="text-sm font-medium text-gray-300 flex-1 cursor-pointer">Ap√≥s as 12:00: **LAZER GARANTIDO!** (Voc√™ mereceu).</label>
                            </div>
                        </li>
                    </ul>
                </div>
                <!-- DOMINGO -->
                <div class="bg-gray-800 p-5 rounded-xl shadow-lg border-l-4 border-green-500 task-item">
                    <h3 class="text-xl font-bold text-green-400 mb-2">DOMINGO</h3>
                    <p class="text-sm text-gray-400 mb-3">LIVRE | Foco: Descanso Total</p>
                    <ul class="space-y-2">
                        <li data-task="sunday-0" class="flex flex-col mb-3 p-2 rounded-md bg-gray-700/50">
                             <div class="flex items-start">
                                <input type="checkbox" id="sunday-0-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-green-600 rounded" onclick="toggleTask(this)">
                                <label for="sunday-0-check" class="text-sm font-medium text-gray-300 flex-1 cursor-pointer">Recarregar energias e preparar-se mentalmente para a escola/semana.</label>
                            </div>
                        </li>
                        <li data-task="sunday-1" class="flex flex-col mb-3 p-2 rounded-md bg-gray-700/50">
                            <div class="flex items-start">
                                <input type="checkbox" id="sunday-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-green-600 rounded" onclick="toggleTask(this)">
                                <label for="sunday-1-check" class="text-sm font-medium text-gray-300 flex-1 cursor-pointer">Nenhuma tarefa de marketing obrigat√≥ria!</label>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data Structure for Routine (Updated for 3 products and 6 posts - NOVO HOR√ÅRIO)
        const routineData = [
            { day: 'SEGUNDA', color: 'red', tasks: [
                { time: '15:00 - 15:45', focus: 'Pesquisa R√°pida (P1 e P2)', product: 'P1/P2', task: 'Encontrar 5 t√≥picos e 5 ganchos de conte√∫do para VPN e 5 para o Produto Nacional.' },
                { time: '15:45 - 16:30', focus: 'Roteiro (P3) - M√≥d. 1', product: 'P3: Milhas/Pr√≥prio', task: 'Estruturar o Roteiro 1: Copy de Alto N√≠vel e Ganchos (Deep Work para o seu Infoproduto).' },
                { time: '16:30 - 17:15', focus: 'Roteiro (P3) - M√≥d. 2', product: 'P3: Milhas/Pr√≥prio', task: 'Estruturar o Roteiro 2: Storytelling e CTA (Call to Action) de Alta Convers√£o.' },
                { time: '17:15 - 18:00', focus: 'Funil & Copy (P3)', product: 'P3: Milhas/Pr√≥prio', task: '**REVIS√ÉO CR√çTICA:** Revisar a Copy do Link na Bio / Landing Page do P3. (Otimizar taxa de convers√£o do funil).' }
            ]},
            { day: 'TER√áA', color: 'yellow', tasks: [
                { time: '15:00 - 16:30', focus: 'Produ√ß√£o Lote (P1 e P2)', product: 'P1/P2', task: 'Produzir e editar os 2 Posts de VPN e os 2 Posts do Produto Nacional.' },
                { time: '16:30 - 18:00', focus: 'Agendamento em Bloco', product: 'P1 e P2', task: 'Revisar links/legendas/hashtags e AGENDAR todos os 4 posts de P1 e P2 (Volume).' }
            ]},
            { day: 'QUARTA', color: 'lime', tasks: [
                { time: '15:00 - 16:00', focus: 'Deep Work (P3) - M√≥d. 1', product: 'P3: Milhas/Pr√≥prio', task: 'Cria√ß√£o do Post 1: Conte√∫do de Valor/Tutorial (Produ√ß√£o de Alta Qualidade do seu Ativo).' },
                { time: '16:00 - 17:00', focus: 'Deep Work (P3) - M√≥d. 2', product: 'P3: Milhas/Pr√≥prio', task: 'Cria√ß√£o do Post 2: Prova Social/Storytelling (Produ√ß√£o de Alta Qualidade do seu Ativo).' },
                { time: '17:00 - 18:00', focus: 'Agendamento Final (P3) & Estoque', product: 'P3/Estoque', task: 'Revisar e AGENDAR os 2 posts do seu Infoproduto Pr√≥prio. Come√ßar a gerar 1 post extra (Estoque).' }
            ]},
            { day: 'QUINTA', color: 'blue', tasks: [
                { time: '15:00 - 15:45', focus: 'Coleta de Dados P1 e P2', product: 'P1/P2', task: '**COLETAR:** CTR (Cliques/Impress√£o) dos links, Engajamento e Visualiza√ß√µes (Base do Afiliado).' },
                { time: '15:45 - 16:30', focus: 'Coleta de Dados P3', product: 'P3: Milhas/Pr√≥prio', task: '**COLETAR:** Taxa de convers√£o do Link na Bio e Coment√°rios/DMs (Base do Lan√ßamento).' },
                { time: '16:30 - 17:15', focus: 'A√ß√£o Corretiva', product: 'TODOS', task: '**REAGIR:** Definir a principal mudan√ßa de Copy/Roteiro para a pr√≥xima semana baseada nos dados coletados.' },
                { time: '17:15 - 18:00', focus: 'Tr√°fego de Perfil', product: 'P1 (VPN) e P3 (Milhas)', task: 'Interagir com 15 perfis concorrentes grandes dos nichos (Ex: 8 Milhas, 7 VPN).' }
            ]},
            { day: 'SEXTA', color: 'indigo', tasks: [
                { time: '15:00 - 16:00', focus: 'Gest√£o Financeira & Alavancagem', product: 'Milhas/Invest/Equipe', task: '**DELEGAR:** Revisar lucros, definir REINVESTIMENTO e distribuir tarefas de edi√ß√£o/log√≠stica para a equipe.' },
                { time: '16:00 - 17:00', focus: 'Estoque de Seguran√ßa', product: 'P1/P2/P3', task: 'Produzir 1 post extra (qualquer nicho) para o estoque de seguran√ßa (contra imprevistos).' },
                { time: '17:00 - 18:00', focus: 'Leitura Estrat√©gica', product: 'Conhecimento', task: 'Ler 30 p√°ginas de um livro/artigo sobre Copywriting, Estrat√©gia ou Finan√ßas.' },
                { time: '18:00 em diante', focus: 'LAZER GARANTIDO/ACADEMIA', product: 'LIVRE', task: '**DESCONEX√ÉO E DIVERS√ÉO!** Tudo pronto, comece a focar no bem-estar.' }
            ]}
        ];
        
        // Fun√ß√£o para renderizar a rotina na UI
        function renderSchedule() {
            const container = document.getElementById('weekly-schedule');
            container.innerHTML = ''; 

            routineData.forEach((dayData, dayIndex) => {
                const dayColor = dayData.color;
                const card = document.createElement('div');
                card.className = `bg-gray-800 p-5 rounded-xl shadow-lg border-l-4 border-${dayColor}-500 task-item`;
                
                let taskListHTML = dayData.tasks.map((task, taskIndex) => `
                    <li data-task="${dayData.day.toLowerCase()}-${taskIndex}" class="flex flex-col mb-3 p-2 rounded-md bg-gray-700/50">
                        <div class="flex items-start">
                            <input type="checkbox" id="${dayData.day.toLowerCase()}-${taskIndex}" 
                                class="mr-2 mt-1 form-checkbox h-4 w-4 text-${dayColor}-600 rounded" 
                                onclick="toggleTask(this)">
                            <label for="${dayData.day.toLowerCase()}-${taskIndex}" class="text-sm font-medium text-gray-300 flex-1 cursor-pointer">${task.task}</label>
                        </div>
                        <div class="ml-6 text-xs text-gray-400 mt-1">
                            <span class="font-bold mr-2">${task.time}:</span> ${task.focus} (${task.product})
                        </div>
                    </li>
                `).join('');

                card.innerHTML = `
                    <h3 class="text-xl font-bold text-${dayData.color}-400 mb-3">${dayData.day}</h3>
                    <ul class="space-y-2">${taskListHTML}</ul>
                `;
                container.appendChild(card);
            });
        }

        // Fun√ß√£o chamada ao clicar no checkbox
        function toggleTask(checkbox) {
            const listItem = checkbox.closest('li');
            
            // Chama a fun√ß√£o de salvamento do Firebase (definida no bloco <script type="module">)
            if (window.saveProgress) {
                // O salvamento agora ocorre aqui e o update da classe √© feito no saveProgress para garantir a sincronia
                window.saveProgress(listItem.getAttribute('data-task'), checkbox.checked);
                
                // Atualiza√ß√£o visual imediata
                if (checkbox.checked) {
                    listItem.classList.add('completed');
                } else {
                    listItem.classList.remove('completed');
                }
            }
        }

        // Fun√ß√£o principal para carregar o progresso (chamada ap√≥s o login no Firebase)
        window.checkAndLoadTasks = function() {
            renderSchedule();
            window.loadProgress();
        }

        // Inicializa a rotina ao carregar a p√°gina
        window.onload = function() {
            // A inicializa√ß√£o do Firebase est√° no bloco de m√≥dulo e chama renderSchedule/loadProgress ap√≥s o login.
            // Apenas renderiza a estrutura inicial antes do Firebase carregar.
            renderSchedule(); 
        }
    </script>
</body>
</html>
