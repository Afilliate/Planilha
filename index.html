<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Semanal Otimizado (V5.0)</title>
    <script src="https://cdn.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Define as variáveis globais que serão usadas no script principal
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = null;

        // Função utilitária para obter a data da Segunda-feira da semana atual (para ID do documento)
        window.getWeekStartDate = function() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Domingo, 1 = Segunda, ... 6 = Sábado
            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Ajusta para a Segunda
            const monday = new Date(now.setDate(diff));
            return monday.toISOString().split('T')[0];
        }

        // Função obrigatória para inicializar o Firebase
        async function initializeFirebase() {
            setLogLevel('Debug');
            
            // 1. Configuração e Inicialização
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config não encontrado. O rastreamento de progresso não funcionará.");
                 document.getElementById('firebase-status').textContent = "ERRO: Configuração Firebase ausente.";
                 return;
            }

            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            
            document.getElementById('firebase-status').textContent = "Conectando ao banco de dados...";

            // 2. Autenticação
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Erro na autenticação:", error);
                document.getElementById('firebase-status').textContent = "ERRO de Autenticação.";
                return;
            }

            // 3. Listener de Estado de Autenticação (Para garantir que o userId seja definido)
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                    document.getElementById('firebase-status').textContent = `Conectado. Usuário ID: ${window.userId}`;
                    window.checkAndLoadTasks(); // Inicia o carregamento da rotina
                    window.fetchWeeklyHistory(); // Puxa o histórico salvo
                } else {
                    console.error("Usuário desconectado.");
                    document.getElementById('firebase-status').textContent = "Desconectado.";
                }
            });
        }

        window.saveProgress = async function(taskId, isChecked) {
             if (!window.userId || !window.appId) return;

             const weekStartDate = window.getWeekStartDate();
             const docId = weekStartDate; // ID do documento é a data da Segunda-feira
             const docRef = doc(window.db, 
                                 'artifacts', window.appId, 
                                 'users', window.userId, 
                                 'weekly_progress', docId);

             // 1. Obtém o estado atual para evitar sobrescrever dados de outras tarefas
             let currentData = {};
             try {
                 const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     currentData = docSnap.data();
                 }
             } catch (error) {
                 console.error("Erro ao obter dados atuais:", error);
                 return;
             }

             // 2. Atualiza o detalhe da tarefa
             const detailKey = taskId.startsWith('goal-') ? 'goalsDetail' : 'tasksDetail';
             
             if (!currentData[detailKey]) {
                 currentData[detailKey] = {};
             }
             currentData[detailKey][taskId] = isChecked;

             // 3. Calcula o resumo do progresso
             const allTasks = [...document.querySelectorAll('[data-task]')];
             const totalTasks = allTasks.length;
             const completedTasks = allTasks.filter(item => {
                 const checkbox = item.querySelector('input[type="checkbox"]');
                 return checkbox && checkbox.checked;
             }).length;

             const totalGoals = document.querySelectorAll('[data-task^="goal-"]').length;
             const completedGoals = document.querySelectorAll('[data-task^="goal-"] input:checked').length;
             
             const completionPercentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
             
             currentData.totalTasksCompleted = completedTasks;
             currentData.totalGoalsCompleted = completedGoals;
             currentData.completionPercentage = parseFloat(completionPercentage.toFixed(2));
             currentData.totalTasks = totalTasks;
             currentData.totalGoals = totalGoals;
             currentData.date = weekStartDate; // Garante a data da semana
             currentData.timestamp = new Date().toISOString(); // Última atualização

             // 4. Salva no Firestore
             try {
                 await setDoc(docRef, currentData);
                 console.log("Progresso salvo com sucesso para a semana:", docId);
                 window.fetchWeeklyHistory(); // Atualiza o histórico imediatamente
             } catch (error) {
                 console.error("Erro ao salvar progresso:", error);
             }
         }

        window.loadProgress = async function() {
            if (!window.userId || !window.appId) return;

            const weekStartDate = window.getWeekStartDate();
            const docId = weekStartDate;
            const docRef = doc(window.db, 
                                'artifacts', window.appId, 
                                'users', window.userId, 
                                'weekly_progress', docId);

            document.getElementById('firebase-status').textContent = "Carregando progresso da semana...";
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Progresso da semana carregado:", data);
                    document.getElementById('firebase-status').textContent = `Progresso de ${data.date} carregado.`;
                    
                    // Aplica as tarefas concluídas
                    const allTasks = document.querySelectorAll('[data-task]');
                    allTasks.forEach(item => {
                        const taskId = item.getAttribute('data-task');
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        
                        if (!checkbox) return;

                        let isCompleted = false;
                        if (taskId.startsWith('goal-') && data.goalsDetail && data.goalsDetail[taskId]) {
                            isCompleted = data.goalsDetail[taskId];
                        } else if (data.tasksDetail && data.tasksDetail[taskId]) {
                            isCompleted = data.tasksDetail[taskId];
                        }

                        if (isCompleted) {
                            checkbox.checked = true;
                            item.classList.add('completed');
                        } else {
                            checkbox.checked = false;
                            item.classList.remove('completed');
                        }
                    });

                } else {
                    document.getElementById('firebase-status').textContent = "Semana nova! Comece a marcar suas tarefas.";
                }
            } catch (error) {
                console.error("Erro ao carregar progresso:", error);
                document.getElementById('firebase-status').textContent = "ERRO ao carregar o progresso.";
            }
        }
        
        // Função para buscar e exibir todo o histórico
        window.fetchWeeklyHistory = async function() {
            if (!window.userId || !window.appId) return;
            
            const historyContainer = document.getElementById('history-list');
            historyContainer.innerHTML = `<p class="text-gray-400 text-center">Buscando histórico...</p>`;

            const progressRef = collection(window.db, 
                                            'artifacts', window.appId, 
                                            'users', window.userId, 
                                            'weekly_progress');
            
            // Query sem orderBy, para obedecer às regras do Canvas.
            const q = query(progressRef); 
            
            try {
                const querySnapshot = await getDocs(q);
                let historyData = [];

                querySnapshot.forEach((doc) => {
                    historyData.push(doc.data());
                });
                
                // Ordena os dados no cliente (no JavaScript)
                historyData.sort((a, b) => b.date.localeCompare(a.date));

                if (historyData.length === 0) {
                    historyContainer.innerHTML = `<p class="text-gray-400 text-center p-4">Nenhum histórico de semana encontrado ainda.</p>`;
                    return;
                }
                
                let historyHTML = '';
                historyData.forEach(data => {
                    const progress = data.completionPercentage || 0;
                    const goalsDone = data.totalGoalsCompleted || 0;
                    const totalGoals = data.totalGoals || 6; 
                    
                    historyHTML += `
                        <div class="bg-gray-700 p-4 rounded-lg shadow-md flex justify-between items-center mb-2">
                            <div>
                                <p class="text-lg font-bold text-cyan-300">Semana Início: ${data.date}</p>
                                <p class="text-sm text-gray-300">Metas (6 Posts): ${goalsDone} de ${totalGoals} concluídas.</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-extrabold ${progress >= 100 ? 'text-green-400' : progress > 50 ? 'text-yellow-400' : 'text-red-400'}">
                                    ${progress}%
                                </p>
                                <p class="text-xs text-gray-400">Progresso Geral</p>
                            </div>
                        </div>
                    `;
                });

                historyContainer.innerHTML = historyHTML;

            } catch (error) {
                console.error("Erro ao buscar histórico:", error);
                historyContainer.innerHTML = `<p class="text-red-400 text-center p-4">Erro ao carregar histórico: ${error.message}</p>`;
            }
        }
        
        initializeFirebase();
    </script>
    <style>
        /* Estilos customizados para a estética */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fundo escuro */
            color: #e5e7eb;
        }
        .task-item {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        .header-bg {
            background-color: #0e7490; /* Azul Ciano Escuro */
            background-image: linear-gradient(135deg, #0e7490 0%, #0891b2 100%);
        }
        /* Corrigindo a cor dos links (labels) quando marcado */
        .completed label {
            color: #9ca3af; /* Cinza mais suave */
        }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 sm:p-8">
        <!-- Título Principal -->
        <header class="header-bg p-6 rounded-xl shadow-2xl mb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white text-center">
                🌊 Plano Semanal Otimizado (V5.0) para Alavancagem Financeira 🚀
            </h1>
            <p class="text-sm sm:text-base text-cyan-100 text-center mt-2">
                Foco Estratégico 1:1:2. Disciplina = Tarefa Clara + Execução Diária.
            </p>
        </header>

        <!-- Status do Firebase/Usuário -->
        <div class="text-center mb-6">
            <p id="firebase-status" class="text-sm text-yellow-400 p-2 bg-gray-800 rounded-lg">
                Iniciando conexão...
            </p>
        </div>
        
        <!-- Histórico de Progresso Semanal -->
        <div class="mb-10 p-5 bg-gray-900 rounded-xl shadow-2xl border-l-4 border-yellow-500">
            <h2 class="text-2xl font-bold mb-3 text-yellow-400 border-b border-yellow-700 pb-2">
                📈 Histórico de Disciplina Semanal
            </h2>
            <div id="history-list" class="space-y-3">
                <!-- O histórico será carregado aqui -->
                <p class="text-gray-400 text-center p-4">Aguardando conexão com o banco de dados...</p>
            </div>
        </div>


        <!-- Objetivos da Semana -->
        <div class="mb-10 p-5 bg-gray-800 rounded-xl shadow-lg border-l-4 border-fuchsia-500">
            <h2 class="text-2xl font-bold mb-3 text-fuchsia-400">
                🎯 Metas de Criação (6 Posts Totais)
            </h2>
            <p class="text-sm text-gray-400 mb-4">Metas de volume: 2 posts por produto (1:1:1).</p>

            <ul class="space-y-2 grid grid-cols-1 sm:grid-cols-3 gap-x-4">
                <li data-task="goal-vpn-1" class="flex items-start">
                    <input type="checkbox" id="goal-vpn-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-vpn-1-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 1: VPN (Gringo)</label>
                </li>
                <li data-task="goal-vpn-2" class="flex items-start">
                    <input type="checkbox" id="goal-vpn-2-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-vpn-2-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 2: VPN (Gringo)</label>
                </li>
                <li data-task="goal-nacional-1" class="flex items-start">
                    <input type="checkbox" id="goal-nacional-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-nacional-1-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 3: Produto Nacional</label>
                </li>
                <li data-task="goal-nacional-2" class="flex items-start">
                    <input type="checkbox" id="goal-nacional-2-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-nacional-2-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 4: Produto Nacional</label>
                </li>
                 <li data-task="goal-milhas-1" class="flex items-start">
                    <input type="checkbox" id="goal-milhas-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-milhas-1-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 5: Seu Produto (Milhas/Afiliados)</label>
                </li>
                 <li data-task="goal-milhas-2" class="flex items-start">
                    <input type="checkbox" id="goal-milhas-2-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-milhas-2-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 6: Seu Produto (Milhas/Afiliados)</label>
                </li>
            </ul>
        </div>
        
        <!-- Bloco de Trabalho - Dias da Semana -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold mb-5 text-cyan-400 border-b border-cyan-700 pb-2">
                Bloco de Trabalho (18:00h às 21:00h) - Disciplina Focada
            </h2>

            <div id="weekly-schedule" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Tasks will be rendered here by JS -->
            </div>
        </div>

        <!-- Fim de Semana e Lazer -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold mb-5 text-green-400 border-b border-green-700 pb-2">
                Fim de Semana e Lazer (Recarregar Energias)
            </h2>
            <div id="weekend-schedule" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- SÁBADO -->
                <div class="bg-gray-800 p-5 rounded-xl shadow-lg border-l-4 border-green-500 task-item">
                    <h3 class="text-xl font-bold text-green-400 mb-2">SÁBADO</h3>
                    <p class="text-sm text-gray-400 mb-3">10:00 - 12:00 | Foco: Estratégia e Reinvestimento</p>
                    <ul class="space-y-2">
                        <li data-task="saturday-0" class="flex flex-col mb-3 p-2 rounded-md bg-gray-700/50">
                            <div class="flex items-start">
                                <input type="checkbox" id="saturday-0-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-green-600 rounded" onclick="toggleTask(this)">
                                <label for="saturday-0-check" class="text-sm font-medium text-gray-300 flex-1 cursor-pointer">Revisão de Metas de 90 Dias: Alinhar o esforço da semana com o objetivo final (Liberdade Financeira aos 20).</label>
                            </div>
                        </li>
                        <li data-task="saturday-1" class="flex flex-col mb-3 p-2 rounded-md bg-gray-700/50">
                            <div class="flex items-start">
                                <input type="checkbox" id="saturday-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-green-600 rounded" onclick="toggleTask(this)">
                                <label for="saturday-1-check" class="text-sm font-medium text-gray-300 flex-1 cursor-pointer">Após as 12:00: **LAZER GARANTIDO!** (Você mereceu).</label>
                    