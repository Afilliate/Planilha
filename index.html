<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plano Semanal Afiliado Org칙nico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Define as vari치veis globais que ser칚o usadas no script principal
        window.app = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        window.appId = null;

        // Fun칞칚o utilit치ria para obter a data da Segunda-feira da semana atual (para ID do documento)
        window.getWeekStartDate = function() {
            const now = new Date();
            const dayOfWeek = now.getDay(); // 0 = Domingo, 1 = Segunda, ... 6 = S치bado
            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Ajusta para a Segunda
            const monday = new Date(now.setDate(diff));
            return monday.toISOString().split('T')[0];
        }

        // Fun칞칚o obrigat칩ria para inicializar o Firebase
        async function initializeFirebase() {
            setLogLevel('Debug');
            
            // 1. Configura칞칚o e Inicializa칞칚o
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
            window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            if (Object.keys(firebaseConfig).length === 0) {
                 console.error("Firebase config n칚o encontrado. O rastreamento de progresso n칚o funcionar치.");
                 document.getElementById('firebase-status').textContent = "ERRO: Configura칞칚o Firebase ausente.";
                 return;
            }

            window.app = initializeApp(firebaseConfig);
            window.db = getFirestore(window.app);
            window.auth = getAuth(window.app);
            
            document.getElementById('firebase-status').textContent = "Conectando ao banco de dados...";

            // 2. Autentica칞칚o
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                } else {
                    await signInAnonymously(window.auth);
                }
            } catch (error) {
                console.error("Erro na autentica칞칚o:", error);
                document.getElementById('firebase-status').textContent = "ERRO de Autentica칞칚o.";
                return;
            }

            // 3. Listener de Estado de Autentica칞칚o (Para garantir que o userId seja definido)
            onAuthStateChanged(window.auth, (user) => {
                if (user) {
                    window.userId = user.uid;
                    document.getElementById('firebase-status').textContent = `Conectado. Usu치rio ID: ${window.userId}`;
                    window.checkAndLoadTasks(); // Inicia o carregamento da rotina
                    window.fetchWeeklyHistory(); // Puxa o hist칩rico salvo
                } else {
                    console.error("Usu치rio desconectado.");
                    document.getElementById('firebase-status').textContent = "Desconectado.";
                }
            });
        }

        window.saveProgress = async function(taskId, isChecked) {
             if (!window.userId || !window.appId) return;

             const weekStartDate = window.getWeekStartDate();
             const docId = weekStartDate; // ID do documento 칠 a data da Segunda-feira
             const docRef = doc(window.db, 
                                 'artifacts', window.appId, 
                                 'users', window.userId, 
                                 'weekly_progress', docId);

             // 1. Obt칠m o estado atual para evitar sobrescrever dados de outras tarefas
             let currentData = {};
             try {
                 const docSnap = await getDoc(docRef);
                 if (docSnap.exists()) {
                     currentData = docSnap.data();
                 }
             } catch (error) {
                 console.error("Erro ao obter dados atuais:", error);
                 return;
             }

             // 2. Atualiza o detalhe da tarefa
             const detailKey = taskId.startsWith('goal-') ? 'goalsDetail' : 'tasksDetail';
             
             if (!currentData[detailKey]) {
                 currentData[detailKey] = {};
             }
             currentData[detailKey][taskId] = isChecked;

             // 3. Calcula o resumo do progresso
             // PRECISAMOS USAR O DOM PARA PEGAR O ESTADO ATUAL
             const allTasks = [...document.querySelectorAll('[data-task]')];
             const totalTasks = allTasks.length;
             const completedTasks = allTasks.filter(item => {
                 const checkbox = item.querySelector('input[type="checkbox"]');
                 return checkbox && checkbox.checked;
             }).length;

             const totalGoals = document.querySelectorAll('[data-task^="goal-"]').length;
             const completedGoals = document.querySelectorAll('[data-task^="goal-"] input:checked').length;
             
             const completionPercentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
             
             currentData.totalTasksCompleted = completedTasks;
             currentData.totalGoalsCompleted = completedGoals;
             currentData.completionPercentage = parseFloat(completionPercentage.toFixed(2));
             currentData.totalTasks = totalTasks;
             currentData.totalGoals = totalGoals;
             currentData.date = weekStartDate; // Garante a data da semana
             currentData.timestamp = new Date().toISOString(); // 칔ltima atualiza칞칚o

             // 4. Salva no Firestore
             try {
                 await setDoc(docRef, currentData);
                 console.log("Progresso salvo com sucesso para a semana:", docId);
                 window.fetchWeeklyHistory(); // Atualiza o hist칩rico imediatamente
             } catch (error) {
                 console.error("Erro ao salvar progresso:", error);
             }
         }

        window.loadProgress = async function() {
            if (!window.userId || !window.appId) return;

            const weekStartDate = window.getWeekStartDate();
            const docId = weekStartDate;
            const docRef = doc(window.db, 
                                'artifacts', window.appId, 
                                'users', window.userId, 
                                'weekly_progress', docId);

            document.getElementById('firebase-status').textContent = "Carregando progresso da semana...";
            
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Progresso da semana carregado:", data);
                    document.getElementById('firebase-status').textContent = `Progresso de ${data.date} carregado.`;
                    
                    // Aplica as tarefas conclu칤das
                    const allTasks = document.querySelectorAll('[data-task]');
                    allTasks.forEach(item => {
                        const taskId = item.getAttribute('data-task');
                        const checkbox = item.querySelector('input[type="checkbox"]');
                        
                        if (!checkbox) return;

                        let isCompleted = false;
                        if (taskId.startsWith('goal-') && data.goalsDetail && data.goalsDetail[taskId]) {
                            isCompleted = data.goalsDetail[taskId];
                        } else if (data.tasksDetail && data.tasksDetail[taskId]) {
                            isCompleted = data.tasksDetail[taskId];
                        }

                        if (isCompleted) {
                            checkbox.checked = true;
                            item.classList.add('completed');
                        } else {
                            checkbox.checked = false;
                            item.classList.remove('completed');
                        }
                    });

                } else {
                    document.getElementById('firebase-status').textContent = "Semana nova! Comece a marcar suas tarefas.";
                }
            } catch (error) {
                console.error("Erro ao carregar progresso:", error);
                document.getElementById('firebase-status').textContent = "ERRO ao carregar o progresso.";
            }
        }
        
        // NOVA FUN칂츾O PARA BUSCAR E EXIBIR TODO O HIST칍RICO
        window.fetchWeeklyHistory = async function() {
            if (!window.userId || !window.appId) return;
            
            const historyContainer = document.getElementById('history-list');
            historyContainer.innerHTML = `<p class="text-gray-400 text-center">Buscando hist칩rico...</p>`;

            const progressRef = collection(window.db, 
                                            'artifacts', window.appId, 
                                            'users', window.userId, 
                                            'weekly_progress');
            
            // Cria um Query para ordenar pela data da semana
            const q = query(progressRef); // Remover orderBy para evitar erros de 칤ndice (conforme instru칞칚o)
            
            try {
                const querySnapshot = await getDocs(q);
                let historyHTML = '';
                const historyData = [];

                querySnapshot.forEach((doc) => {
                    historyData.push(doc.data());
                });
                
                // Ordena os dados no cliente (no JavaScript)
                historyData.sort((a, b) => b.date.localeCompare(a.date));

                if (historyData.length === 0) {
                    historyContainer.innerHTML = `<p class="text-gray-400 text-center p-4">Nenhum hist칩rico de semana encontrado ainda.</p>`;
                    return;
                }
                
                historyData.forEach(data => {
                    const progress = data.completionPercentage || 0;
                    const goalsDone = data.totalGoalsCompleted || 0;
                    const totalGoals = data.totalGoals || 5; // Assumindo 5 metas
                    
                    historyHTML += `
                        <div class="bg-gray-700 p-4 rounded-lg shadow-md flex justify-between items-center mb-2">
                            <div>
                                <p class="text-lg font-bold text-cyan-300">Semana In칤cio: ${data.date}</p>
                                <p class="text-sm text-gray-300">Metas (5 Posts): ${goalsDone} de ${totalGoals} conclu칤das.</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-extrabold ${progress >= 100 ? 'text-green-400' : progress > 50 ? 'text-yellow-400' : 'text-red-400'}">
                                    ${progress}%
                                </p>
                                <p class="text-xs text-gray-400">Progresso Geral</p>
                            </div>
                        </div>
                    `;
                });

                historyContainer.innerHTML = historyHTML;

            } catch (error) {
                console.error("Erro ao buscar hist칩rico:", error);
                historyContainer.innerHTML = `<p class="text-red-400 text-center p-4">Erro ao carregar hist칩rico: ${error.message}</p>`;
            }
        }
        
        initializeFirebase();
    </script>
    <style>
        /* Estilos customizados para a est칠tica */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fundo escuro */
            color: #e5e7eb;
        }
        .task-item {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .task-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
        .header-bg {
            background-color: #0e7490; /* Azul Ciano Escuro */
            background-image: linear-gradient(135deg, #0e7490 0%, #0891b2 100%);
        }
        /* Corrigindo a cor dos links (labels) quando marcado */
        .completed label {
            color: #9ca3af; /* Cinza mais suave */
        }
    </style>
</head>
<body>

    <div class="min-h-screen p-4 sm:p-8">
        <!-- T칤tulo Principal -->
        <header class="header-bg p-6 rounded-xl shadow-2xl mb-4">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white text-center">
                游깱 Plano Semanal: Afiliado Org칙nico 游
            </h1>
            <p class="text-sm sm:text-base text-cyan-100 text-center mt-2">
                Foco total: 18:00h - 21:00h | Progresso salvo no banco de dados.
            </p>
        </header>

        <!-- Status do Firebase/Usu치rio -->
        <div class="text-center mb-6">
            <p id="firebase-status" class="text-sm text-yellow-400 p-2 bg-gray-800 rounded-lg">
                Iniciando conex칚o...
            </p>
        </div>
        
        <!-- Hist칩rico de Progresso Semanal -->
        <div class="mb-10 p-5 bg-gray-900 rounded-xl shadow-2xl border-l-4 border-yellow-500">
            <h2 class="text-2xl font-bold mb-3 text-yellow-400 border-b border-yellow-700 pb-2">
                游늳 Hist칩rico de Progresso Semanal
            </h2>
            <div id="history-list" class="space-y-3">
                <!-- O hist칩rico ser치 carregado aqui -->
                <p class="text-gray-400 text-center p-4">Aguardando conex칚o com o banco de dados...</p>
            </div>
        </div>


        <!-- Objetivos da Semana -->
        <div class="mb-10 p-5 bg-gray-800 rounded-xl shadow-lg border-l-4 border-fuchsia-500">
            <h2 class="text-2xl font-bold mb-3 text-fuchsia-400">
                游꿢 Objetivos de Conte칰do da Semana (5 Posts)
            </h2>
            <p class="text-sm text-gray-400 mb-4">Marcar estas caixas garante que voc칡 cumpriu o volume m칤nimo de cria칞칚o.</p>

            <ul class="space-y-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                <li data-task="goal-vpn-1" class="flex items-start">
                    <input type="checkbox" id="goal-vpn-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-vpn-1-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 1: VPN Tutorial/Review (Gringo)</label>
                </li>
                <li data-task="goal-vpn-2" class="flex items-start">
                    <input type="checkbox" id="goal-vpn-2-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-vpn-2-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 2: VPN Dica de Seguran칞a (Gringo)</label>
                </li>
                <li data-task="goal-kiwify-1" class="flex items-start">
                    <input type="checkbox" id="goal-kiwify-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-kiwify-1-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 3: Kiwify Dica R치pida (Nacional)</label>
                </li>
                <li data-task="goal-kiwify-2" class="flex items-start">
                    <input type="checkbox" id="goal-kiwify-2-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-kiwify-2-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 4: Kiwify Prova Social/Storytelling (Nacional)</label>
                </li>
                 <li data-task="goal-kiwify-3" class="flex items-start">
                    <input type="checkbox" id="goal-kiwify-3-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-fuchsia-600 rounded" onclick="toggleTask(this)">
                    <label for="goal-kiwify-3-check" class="text-base text-gray-300 flex-1 cursor-pointer">Post 5: Kiwify Viral/Tend칡ncia (Nacional)</label>
                </li>
            </ul>
        </div>
        
        <!-- Bloco de Trabalho - Dias da Semana -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold mb-5 text-cyan-400 border-b border-cyan-700 pb-2">
                Bloco de Trabalho (18:00h 맙 21:00h)
            </h2>

            <div id="weekly-schedule" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Tasks will be rendered here by JS -->
            </div>
        </div>

        <!-- Fim de Semana e Lazer (N칚o atualizado, mas essencial) -->
        <div class="mb-10">
            <h2 class="text-2xl font-bold mb-5 text-green-400 border-b border-green-700 pb-2">
                Fim de Semana e Lazer (Recarregar Energias)
            </h2>
            <div id="weekend-schedule" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- S츼BADO -->
                <div class="bg-gray-800 p-5 rounded-xl shadow-lg border-l-4 border-green-500 task-item">
                    <h3 class="text-xl font-bold text-green-400 mb-2">S츼BADO</h3>
                    <p class="text-sm text-gray-400 mb-3">10:00 - 12:00 | Foco: Aprendizado/Aprimoramento</p>
                    <ul class="space-y-2">
                        <li data-task="saturday-0" class="flex flex-col mb-3 p-2 rounded-md bg-gray-700/50">
                            <div class="flex items-start">
                                <input type="checkbox" id="saturday-0-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-green-600 rounded" onclick="toggleTask(this)">
                                <label for="saturday-0-check" class="text-sm font-medium text-gray-300 flex-1 cursor-pointer">Consumir 2h de conte칰do de valor (cursos, v칤deos, leitura).</label>
                            </div>
                        </li>
                        <li data-task="saturday-1" class="flex flex-col mb-3 p-2 rounded-md bg-gray-700/50">
                            <div class="flex items-start">
                                <input type="checkbox" id="saturday-1-check" class="mr-2 mt-1 form-checkbox h-4 w-4 text-green-600 rounded" onclick="toggleTask(this)">
                                <label for="saturday-1-check" class="text-sm font-medium text-gray-300 flex-1 cursor-pointer">Ap칩s as 12:00: **LAZER GARANTIDO!**</label>
                            </div>
                        </li>
                    </ul>
                </div>
                <!-- DOMINGO -->
                <div class="bg-gray-800 p-5 rounded-xl shadow-lg border-l-4 border-green-500 task-item">
                    <h3 class="text-xl font-bold text-green-400 mb-2">DOMINGO</h3>